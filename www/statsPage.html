<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet">
    <title>Document</title>
</head>
<body>

    <div class="centered">

        <h1>Concurrent HTTP Server</h1>
        <p>Lu√≠s Correia | 125264</p>
        <br>
        <p>Guilherme Martins | 125260</p>

        <hr>

        <p id="stats"></p>
        <p id="lastFetchedStatsDate"></p>
        <script>
            const statsElement = document.getElementById("stats");
            const lastFetchedDateDisplay = document.getElementById("lastFetchedStatsDate");

            function refreshStats() {
                // 1. Corrected fetch syntax
                fetch('statFile.txt')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(data => {
                        const dataArray = data.split(",");
                        // 2. Map strings to numbers for validation and display
                        const numericData = dataArray.map(element => parseFloat(element.trim()));

                        // Validate if ALL elements are valid finite numbers
                        const dataIsValid = numericData.every(element => {
                            return typeof element === 'number' && isFinite(element);
                        });

                        if (numericData.length === 6) {
                            // Data is valid and has the expected number of elements
                            statsElement.innerText = 
                                "Active connections: " + numericData[0] + "\n" +
                                "Total bytes transferred: " + numericData[1] + " B\n" +
                                "Status 200 count: " + numericData[2] + "\n" +
                                "Status 404 count: " + numericData[3] + "\n" +
                                "Status 500 count: " + numericData[4] + "\n" +
                                "Total requests count: " + numericData[5];
                        } else {
                            // Handle invalid/incomplete data without an infinite loop
                            statsElement.innerText = "Error: Stats file contains invalid or incomplete data.";
                        }
                    })
                    .catch(err => {
                        // Catches network errors, HTTP errors (from the throw above), and parsing errors
                        statsElement.innerText = "Error reading stats: " + err.message;
                    });

                var currentdate = new Date(); 
                var datetime = "Stats fetched at " + currentdate.getDate() + "/"
                                + (currentdate.getMonth()+1)  + "/" 
                                + currentdate.getFullYear() + " @ "  
                                + currentdate.getHours() + ":"  
                                + currentdate.getMinutes() + ":" 
                                + currentdate.getSeconds();
                lastFetchedDateDisplay.innerHTML = datetime;
            }

            // refresh stats on page load
            refreshStats();

            setInterval(refreshStats, 5000);
        </script>
    </div>
    
    <a id="github-btn" target="_blank" rel="noopener noreferrer" href="https://github.com/LuisPCNeri/Concurrent-HTTP-Server">
        <img src="github-white-icon.png" width="96px" height="96px" alt="Github repo" title="Github repo">
    </a>

    <script src="script.js"></script>
    
</body>
</html>